<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/bower_components/iron-pages/iron-pages.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/bower_components/paper-menu/paper-menu.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/iron-image/iron-image.html">
<link rel="import" href="/bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="/bower_components/paper-header-panel/paper-header-panel.html">

<dom-module id="my-thingy">

  <template>
    <iron-ajax url="/api/search" params="{{searchParams}}" last-response="{{data}}" auto></iron-ajax>
    <span>{{data.Num}}</span>

    <paper-drawer-panel>
      <paper-header-panel drawer>
        <paper-toolbar id="navheader">
          <span>Menu</span>
        </paper-toolbar>
        <paper-menu id="menu">

          <template is="dom-repeat" items="{{data.Results}}">
            <paper-item>
              <iron-image src="{{rawLink(item.RawImage)}}" preload sizing="contain" style="width: 100px; height: 100px"></iron-image>
            </paper-item>
          </template>

        </paper-menu>
      </paper-header-panel>

      <paper-header-panel main>
        <paper-toolbar id="mainheader">
          <form action="/search">
            <input type="search" name="q" value="{{query}}" id="query">
            <input type="submit" value="Search">
          </form>
        </paper-toolbar>
        <iron-pages id="pages">

          <template is="dom-repeat" items="{{data.Results}}">
            <div>
              <a href="{{link(item.ID)}}">
                <iron-image src="{{rawLink(item.RawImage)}}" preload sizing="contain" style="width: 100%; height: 100%"></iron-image>
              </a>
            </div>
          </template>

        </iron-pages>
      </paper-header-panel>

    </paper-drawer-panel>

  </template>

  <script>
    Polymer({
      is: "my-thingy",
      rawLink: function(x) { return '/_image/' + x },
      link: function(x) { return '/image/' + x },
      query: "",
      ready: function () {
        var params = window.location.search.substring(1).split('&').reduce(function(a,b){var c=b.split('=');a[c[0]]=c[1];return a}, {})
        this.query = params['q']
        this.searchParams = {q: this.query}
        console.log(this.query)

        var menu = this.$.menu
        var pages = this.$.pages

        menu.addEventListener('iron-select', function() {
          pages.select(this.selected)
        })

        document.onkeyup = function(e){
          var move = 0
          if (e.keyIdentifier === 'U+004B') {
            menu.selectPrevious()
          } else if (e.keyIdentifier === 'U+004A') {
            menu.selectNext()
          }
        }

        menu.select(0)
      }
    })
  </script>

  <style>
    /* fix height on images */
    #mainPanel,
    #mainContainer,
    html /deep/ paper-header-panel[main],
    html /deep/ iron-pages,
    html /deep/ iron-pages div {
      height: 100%;
    }
  </style>
</dom-module>
